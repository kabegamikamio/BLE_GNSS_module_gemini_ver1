# BLE_GNSS_module_gemini_ver1
GNSSモジュールで取得した位置情報をBLE-LNSでiPhone等のデバイスに送信するプログラム。
GnssCircuitLoggerとの互換性を確認しています。

## 動作確認済み環境
- ESP32 DevKitC WROOM-32U
- GNSSモジュール: Quescan G10B-F30
- iPhone 15 Pro, iPhone SE2
- GnssCircuitLogger v1.6.5

## 基本的な使い方
- [こちら](https://minkara.carview.co.jp/userid/3475803/car/3322507/8352285/note.aspx)のみんカラを参考に、回路、GNSSモジュールの準備をします。
- このリポジトリの `BLE_GNSS_gemini_ver1.ino` をArduino IDEなどでESP32に焼きます。
- あとはPlug & Playです。GnssCircuitLoggerの設定からBLE GNSSデバイス `KawaiiMyGNSS` を選択し、ラップタイマーを開始します。

## 初期設定
- 測位頻度: 10Hz (変更するにはプログラムだけでなく、GNSSモジュール側設定も変更が必要です)
- 速度データソース: GNSSから送られるデータ (GxRMCの速度フィールド)
- 速度の平滑化: 有効、直近5件の移動平均

## 応用的な使い方
Arduino IDEからプログラムを書き換えなくても、一部の設定値は外部から更新することができます。
設定変更方法として、「USBシリアル通信」と「BLE」の2つの媒体をサポートします。

### 移動平均区間の設定
- Arduino IDEなどのシリアルモニタで数値を送ると、その数値分の移動平均を取るようになります。
  - e.g., シリアルモニタのテキストボックスから `10` を送信 &rightarrow; 直近10件の移動平均を現在の速度とする
- LightBlueなどのBLE評価アプリを使うと、iPhoneからも設定変更が可能です。
  - LightBlueから `KawaiiMyGNSS` に接続し、 `0xC48E6067` サービスの `0xC48E6068` キャラクタリスティックを開きます。「Write value」ボタンから希望の移動平均区間を16進数で入力して送信します。
  - e.g., 直近10件の移動平均を取りたい &rightarrow; `0A` を送ります。
  - 「Read」ボタンを押すと、現在の設定を見ることができます。例えば `0x35` なら区間は5、 `0x3135` なら区間は10というように設定されていることがわかります。
- いずれの方法でも、 `0` を送ると移動平均による平滑化が無効になります。安定して速度情報が取れる環境でしたら、平滑化は不要だと思います。

### 測位頻度の設定
- シリアルモニタから設定する場合、 `xxHz` と送ります。「xx」は設定したい測位頻度です。
- BLEから設定する場合、 `0xC48E6069` キャラクタリスティックを開き、「Write value」ボタンから希望の測位頻度を16進数で送信します。
  - 例えば25Hzに設定したい場合は、 `19` を送ります。

### ボーレートの変更(2025/09/03 不具合のため使用非推奨)
- ボーレートの変更がGNSSモジュールに適用されない不具合があるため、不具合修正まではこの機能は使わないでください。
- 設定可能なボーレートはあらかじめ固定されています。以下のボーレートが利用可能です:
```
9600, 19200, 31250, 38400, 57600, 75880,
115200, 230400, 250000, 460800
```
- シリアルモニタから設定する場合、 `xxxbps` と送ります。「xxx」は設定したいボーレートです。
- BLEから設定する場合、 `0xC48E6067` サービスの `0xC48E606A` キャラクタリスティックを開き、「Write value」から設定したいボーレートを2進数で送信します。
  - 例えば115200に設定したい場合、 `1C200` を送ります。
 
## 改変、再頒布、商用利用について
- 個人での利用に限り、プログラムの改変を許可します。
- 改変しない状態に限り、再頒布を許可します。ただし作者名(kabegamikamio)を明記してください。
- 商用利用は原則禁止です。
- 他、プログラムの使用に関して不明な点がある場合は、Issuesからお問い合わせください。
 
## 不具合等の報告について
- みんカラのコメントまたは当GithubレポジトリのIssuesから問題報告を行ってください。
  - Yuji Kanda様は本デバイスの製作に直接関与していません。本デバイス、プログラムについての問い合わせは必ず私 `kabegamikamio` までお願いいたします。

## 謝辞
GnssCircuitLoggerの仕様に関する情報提供をしてくださった Yuji Kanda 様にこの場を借りて謝意を表します。

## 免責事項
- 当プログラムやみんカラ等で紹介したデバイスの製作、使用によって引き起こされた一切の損害について、私をはじめGnssCircuitLoggerの制作者である Yuji Kanda様は責任を負わないものとします。
- 走行中にデバイスやアプリの操作を行わないでください。
- デバイスの取り付けは確実に行ってください。走行中デバイスが脱落するなどして運転操作に支障をきたす可能性があります。
